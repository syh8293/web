<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>책 만쪽 읽기 기록</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f7f7f5;
      color: #222;
      max-width: 480px;
      margin: 0 auto;
      padding: 24px;
    }
    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.5rem;
    }
    .sub {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 1.5rem;
    }
    .card {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 16px;
    }
    label {
      display: block;
      font-size: 0.85rem;
      margin-bottom: 4px;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
    }
    button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background: #2f6fed;
      color: white;
      font-size: 1rem;
      cursor: pointer;
    }
    .progress {
      height: 12px;
      background: #e5e5e5;
      border-radius: 6px;
      overflow: hidden;
      margin-top: 8px;
    }
    .bar {
      height: 100%;
      background: #2f6fed;
      width: 0%;
    }
    .small {
      font-size: 0.85rem;
      color: #555;
      margin-top: 6px;
    }
  </style>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#2f6fed" />
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>
</head>
<body>
  <h1>책 만쪽 읽기</h1>
  <div class="sub">숫자로 남기는 조용한 독서의 기록</div>

  <div class="card">
    <label>오늘 날짜</label>
    <input type="date" id="date" />

    <label>책 제목</label>
    <input type="text" id="title" placeholder="선택 사항" />

    <label><input type="checkbox" id="bookChanged" /> 책이 바뀌었습니다</label>

    <label>책 전체 페이지 (선택)</label>
    <input type="number" id="totalPages" placeholder="모를 경우 비워두세요" />

    <label>오늘 읽기 시작한 페이지</label>
    <input type="number" id="startPage" />

    <label>오늘 읽기 종료한 페이지</label>
    <input type="number" id="endPage" />

    <label>메모</label>
    <textarea id="memo" rows="2" placeholder="짧은 생각"></textarea>

    <button onclick="saveEntry()">기록하기</button>
  </div>

  <div class="card">
    <div id="total">누적 페이지: 0 / 10,000</div>
    <div class="progress">
      <div class="bar" id="bar"></div>
    </div>
    <div class="small" id="message"></div>
    <div class="small" id="autoMessage"></div>
    <div class="small" id="completeMessage"></div>
  </div>

  <div class="card" style="max-height:300px; overflow-y:auto;">
    <h2 style="font-size:1rem; margin-bottom:8px;">날짜별 기록</h2>
    <ul id="entryList" style="padding-left:16px; font-size:0.9rem;"></ul>
  </div>

  <div class="card">
    <h2 style="font-size:1rem; margin-bottom:8px;">완독한 책</h2>
    <ul id="completedList" style="padding-left:16px; font-size:0.9rem;"></ul>
  </div>
  </div>

  <script>
    const TARGET = 10000;

    function loadEntries() {
      return JSON.parse(localStorage.getItem('readingEntries') || '[]');
    }

    function saveEntries(entries) {
      localStorage.setItem('readingEntries', JSON.stringify(entries));
    }

    function saveEntry() {
      const start = Number(document.getElementById('startPage').value);
      const end = Number(document.getElementById('endPage').value);

      const totalPages = Number(document.getElementById('totalPages').value);

      const entry = {
        date: document.getElementById('date').value,
        title: document.getElementById('title').value,
        startPage: start,
        endPage: end,
        totalPages: totalPages || null,
        pages: Math.max(0, end - start + 1),
        memo: document.getElementById('memo').value
      };

      if (!entry.date || !entry.startPage || !entry.endPage) return;

      const entries = loadEntries();
      entries.push(entry);
      saveEntries(entries);

      const auto = !document.getElementById('bookChanged').checked;

      if (auto) {
        document.getElementById('startPage').value = end + 1;
        document.getElementById('autoMessage').innerText = '어제의 끝에서 다시 시작합니다.';
      } else {
        document.getElementById('startPage').value = '';
        document.getElementById('autoMessage').innerText = '';
      }

      document.getElementById('bookChanged').checked = false;

      // 다음 읽기를 위해 시작 페이지를 자동으로 설정
      document.getElementById('startPage').value = end + 1;

      updateProgress();

      if (entry.totalPages && end >= entry.totalPages) {
        document.getElementById('completeMessage').innerText = '★ 한 권을 끝까지 읽었습니다.';
      } else {
        document.getElementById('completeMessage').innerText = '';
      }
    }

    function updateProgress() {
      const entries = loadEntries();
      const total = entries.reduce((sum, e) => sum + (e.pages || 0), 0);
      const percent = Math.min((total / TARGET) * 100, 100);

      document.getElementById('total').innerText = `누적 페이지: ${total} / ${TARGET}`;
      document.getElementById('bar').style.width = percent + '%';

      const daily = Math.ceil((TARGET - total) / Math.max(1, 365 - entries.length));
      document.getElementById('message').innerText =
        total >= TARGET
          ? '이미 목적지에 도착했습니다.'
          : `내일은 약 ${daily}페이지면 충분합니다.`;

      updateCompletedBooks(entries);
      updateEntryList(entries);
    }

    updateProgress();

    function updateEntryList(entries) {
      const list = document.getElementById('entryList');
      if (!list) return;

      list.innerHTML = '';
      entries.slice().reverse().forEach(e => {
        const li = document.createElement('li');
        li.style.cursor = 'pointer';
        li.innerText = `${e.date} · ${e.title || '제목 없는 책'} (${e.pages}p)`;
        li.onclick = () => {
          const edit = confirm(
            `날짜: ${e.date}
` +
            `책: ${e.title || '제목 없음'}
` +
            `읽은 구간: ${e.startPage}p ~ ${e.endPage}p
` +
            `페이지 수: ${e.pages}p
` +
            `메모: ${e.memo || '없음'}

` +
            `이 기록을 수정하시겠습니까?`
          );

          if (edit) {
            document.getElementById('date').value = e.date;
            document.getElementById('title').value = e.title;
            document.getElementById('startPage').value = e.startPage;
            document.getElementById('endPage').value = e.endPage;
            document.getElementById('memo').value = e.memo;

            entries.splice(entries.indexOf(e), 1);
            saveEntries(entries);
            updateProgress();
          }
        };
        };
        list.appendChild(li);
      });
    }

    function updateCompletedBooks(entries) {
      const list = document.getElementById('completedList');
      if (!list) return;

      const completed = {};

      entries.forEach(e => {
        if (e.totalPages && e.endPage >= e.totalPages) {
          completed[e.title || '제목 없는 책'] = true;
        }
      });

      list.innerHTML = '';
      Object.keys(completed).forEach(title => {
        const li = document.createElement('li');
        li.innerText = title;
        list.appendChild(li);
      });
    }
  </script>
</body>
</html>
