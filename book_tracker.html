<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>2026 독서 동기화 트래커</title>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, push, onValue, remove, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // ⚠️ 본인의 Firebase 설정값을 입력하세요
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            databaseURL: "https://YOUR_PROJECT_ID-default-rtdb.firebaseio.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logsRef = ref(db, 'logs');

        let editingId = null; // 수정 중인 로그 ID 저장

        // 실시간 데이터 수신
        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            updateDisplay(data);
            updateBookList(data); // 책 목록 업데이트
        });

        // 1. 책 제목 목록 자동 업데이트 (중복 제거)
        function updateBookList(data) {
            const datalist = document.getElementById('book-list');
            datalist.innerHTML = '';
            if (!data) return;
            const titles = [...new Set(Object.values(data).map(log => log.title))];
            titles.forEach(title => {
                const option = document.createElement('option');
                option.value = title;
                datalist.appendChild(option);
            });
        }

        // 2. 기록 저장 및 수정
        window.saveLog = () => {
            const title = document.getElementById('book-title').value;
            const date = document.getElementById('read-date').value;
            const start = parseInt(document.getElementById('start-page').value);
            const end = parseInt(document.getElementById('end-page').value);

            if (!title || isNaN(start) || isNaN(end)) { alert('내용을 입력해주세요.'); return; }

            const logData = { title, date, startPage: start, endPage: end };

            if (editingId) {
                // 수정 모드
                update(ref(db, `logs/${editingId}`), logData);
                editingId = null;
                document.getElementById('btn-save').innerText = "오늘 독서 완료";
            } else {
                // 신규 저장 모드
                push(logsRef, logData);
            }

            // 입력창 초기화
            document.getElementById('end-page').value = '';
            document.getElementById('start-page').value = end;
        };

        // 3. 수정 모드 진입
        window.editLog = (id, title, date, start, end) => {
            editingId = id;
            document.getElementById('book-title').value = title;
            document.getElementById('read-date').value = date;
            document.getElementById('start-page').value = start;
            document.getElementById('end-page').value = end;
            document.getElementById('btn-save').innerText = "기록 수정하기";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };

        window.deleteLog = (id) => { if(confirm('삭제할까요?')) remove(ref(db, `logs/${id}`)); };

        function updateDisplay(data) {
            const container = document.getElementById('log-container');
            const totalDisplay = document.getElementById('total-pages');
            const progressBar = document.getElementById('progress-bar');
            container.innerHTML = '';
            let total = 0;

            if (data) {
                Object.entries(data).reverse().forEach(([id, log]) => {
                    const amount = log.endPage - log.startPage;
                    total += amount;
                    const div = document.createElement('div');
                    div.className = 'log-item';
                    div.innerHTML = `
                        <div class="log-info">
                            <strong>${log.title}</strong>
                            <span>${log.date} | ${log.startPage}p - ${log.endPage}p</span>
                            <div>
                                <button class="edit-btn" onclick="editLog('${id}', '${log.title}', '${log.date}', ${log.startPage}, ${log.endPage})">수정</button>
                                <button class="delete-btn" onclick="deleteLog('${id}')">삭제</button>
                            </div>
                        </div>
                        <div class="page-tag">+${amount}P</div>
                    `;
                    container.appendChild(div);
                });
            }
            totalDisplay.innerText = total.toLocaleString();
            const percent = Math.min((total / 10000) * 100, 100).toFixed(1);
            progressBar.style.width = percent + '%';
            document.getElementById('percent').innerText = `${percent}% 달성 중!`;
        }
    </script>
    <style>
        :root { --primary-color: #6c5ce7; --bg-color: #f0f2f5; }
        body { font-family: -apple-system, sans-serif; background: var(--bg-color); padding: 15px; margin: 0; }
        .total-stats { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; padding: 25px; border-radius: 20px; text-align: center; box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .progress-container { background: rgba(255,255,255,0.3); height: 10px; border-radius: 5px; margin: 15px 0; }
        .progress-bar { background: white; height: 100%; width: 0; border-radius: 5px; transition: 0.5s; }
        .input-section { background: white; padding: 20px; border-radius: 20px; margin: 20px 0; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        input { width: 100%; padding: 14px; margin-bottom: 10px; border: 1px solid #eee; border-radius: 12px; box-sizing: border-box; font-size: 16px; background: #f9f9f9; }
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #btn-save { width: 100%; padding: 16px; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .log-item { background: white; padding: 18px; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; }
        .page-tag { font-weight: 800; color: var(--primary-color); font-size: 1.2rem; }
        .edit-btn { color: #0984e3; border: none; background: none; margin-right: 10px; cursor: pointer; padding: 0; }
        .delete-btn { color: #d63031; border: none; background: none; cursor: pointer; padding: 0; }
    </style>
</head>
<body>
    <div style="max-width: 500px; margin: 0 auto;">
        <header>
            <div class="total-stats">
                <div style="font-size: 0.9rem; opacity: 0.8;">2026 독서 챌린지</div>
                <div style="font-size: 2.2rem; font-weight: 800; margin: 5px 0;"><span id="total-pages">0</span> <small style="font-size:1rem">/ 10,000 P</small></div>
                <div class="progress-container"><div id="progress-bar" class="progress-bar"></div></div>
                <div id="percent" style="font-size: 0.9rem;">0%</div>
            </div>
        </header>

        <div class="input-section">
            <input type="text" id="book-title" list="book-list" placeholder="책 제목을 입력하거나 선택하세요">
            <datalist id="book-list"></datalist> <input type="date" id="read-date">
            <div class="row">
                <input type="number" id="start-page" placeholder="시작(p)" inputmode="numeric">
                <input type="number" id="end-page" placeholder="종료(p)" inputmode="numeric">
            </div>
            <button id="btn-save" onclick="saveLog()">오늘의 독서 기록 완료</button>
        </div>
        <div id="log-container"></div>
    </div>
</body>
</html>